# AI 配额系统说明 - 用户不会失去已赚取的奖励

## 核心设计原则

✨ **用户在平台获得的任何奖励配额都永久有效，绝不过期。**

---

## 配额两层结构

### 层级 1：每日免费配额（会重置）
- **数量**：10 次/日
- **重置时间**：每天 0 点
- **有效期**：仅限当天使用（24 小时）
- **规则**：用完即清零，次日重置为 10 次

### 层级 2：累积奖励配额（永不过期）✨
- **来源**：
  - 完成"轻松"难度关卡 → +10 次（日最多 3 次）
  - 完成"挑战"难度关卡 → +20 次（日最多 2 次）
  - 分享文章至朋友圈/群组 → +10 次（日最多 3 次）
- **有效期**：**永远有效，永不过期**
- **累积方式**：可无限累积，不受任何时间限制
- **使用顺序**：当日免费用完后，自动扣除累积奖励

---

## 用户体验示例

### 场景 1：一个活跃用户的真实情况

**Week 1：**
```
Mon: 完成 1 game + 分享 1 篇 = +30 配额累积
Tue: 完成 2 game + 分享 2 篇 = +50 配额累积
Wed: 完成 1 game + 分享 1 篇 = +30 配额累积
...
累积总计：110+ 配额
```

**Week 2（几天未使用）：**
```
之前累积的 110+ 配额 ✨ 完全保留
没有任何失效、清零或过期
用户登录一周后，配额仍然全部可用
```

---

### 场景 2：配额不足时的提示

```
用户想提问，但：
  → 今日免费：0/10（已用完）
  → 累积奖励：3 次（剩余）

界面显示：
"您的今日免费配额已用完。您有 3 次累积奖励配额可用。
完成轻松关卡或分享文章可快速获得更多配额！"

提问消耗：3 次累积配额
提问成功 ✓

第二天：
新的 10 次免费配额到账 ✓
累积配额 0 次（仍有机制获得更多）
```

---

## 后端数据表结构

### users 表（关键字段）
```sql
-- 日免费配额
ai_daily_quota INT DEFAULT 10           -- 今日剩余免费次数
ai_daily_reset_at TIMESTAMP             -- 下次重置时间

-- 累积奖励配额 ✨ 关键
ai_accumulated_quota INT DEFAULT 0      -- 通过任务赚取的配额（永久有效）

-- 今日任务计数（限制日奖励上限）
games_easy_completed_today INT DEFAULT 0    -- 今日完成 easy 关卡数（限 3）
games_hard_completed_today INT DEFAULT 0    -- 今日完成 hard 关卡数（限 2）
articles_shared_today INT DEFAULT 0         -- 今日分享文章数（限 3）
task_reset_at TIMESTAMP                     -- 任务计数重置时间
```

### article_shares 表（记录分享奖励）
```sql
CREATE TABLE article_shares (
  id UUID PRIMARY KEY,
  user_id UUID,
  article_id UUID,
  share_channel VARCHAR(50),      -- 'moments' | 'group'
  quota_rewarded INT DEFAULT 10,  -- 赠送的配额数
  share_verified BOOLEAN,         -- 是否验证完成
  created_at TIMESTAMP
);
```

### game_quota_rewards 表（记录关卡奖励）
```sql
CREATE TABLE game_quota_rewards (
  id UUID PRIMARY KEY,
  user_id UUID,
  level_id UUID,
  difficulty VARCHAR(50),         -- 'easy' | 'hard'
  quota_rewarded INT,             -- easy: 10, hard: 20
  created_at TIMESTAMP
);
```

---

## API 配额查询示例

### 获取配额接口 (GET /api/ai/quota)

```json
{
  "daily": {
    "free": 10,
    "used": 3,
    "remaining": 7,
    "resets_at": "2025-01-16T00:00:00Z"
  },
  "accumulated": {
    "earned": 47,           // ✨ 永久有效
    "never_expires": true
  },
  "total_available": 54,    // 7 + 47 = 总可用
  "breakdown": "今日免费：7/10 | 累积奖励：47 次（永不过期）"
}
```

---

## 防止用户投诉的关键点

### ✅ 前端提示文案
```
今日免费：X/10（今晚 24:00 清零）
累积奖励：X 次（永久有效 ✨ 永不过期）
```

### ✅ 赚取时的反馈
```
完成关卡时弹窗：「✓ 已赚取 +10 AI 配额（永久保留）」
分享文章时弹窗：「✓ 已赚取 +10 AI 配额（永久保留）」
```

### ✅ 配额不足时的提示
```
「您的今日免费配额已用完。您有 X 次累积奖励配额。
这些配额是您通过关卡/分享赚取的，永久有效，随时可用。」
```

### ✅ 隐私政策中的说明
```
「平台保证：用户通过完成关卡或分享文章获得的配额配额永久有效，
不会因时间推移或任何原因被清零或收回。用户享有对这些配额的永久所有权。」
```

---

## 开发注意事项

### 日配额重置逻辑
```typescript
// 每次查询配额时
if (currentTime > user.ai_daily_reset_at) {
  // 重置日配额
  user.ai_daily_quota = 10;  // ✓ 重置
  user.ai_daily_reset_at = tomorrow_midnight();
  user.games_easy_completed_today = 0;  // ✓ 重置任务计数
  user.games_hard_completed_today = 0;
  user.articles_shared_today = 0;
  // ⚠️ 不要动 ai_accumulated_quota！
  user.ai_accumulated_quota = user.ai_accumulated_quota;  // ✓ 保留！
}
```

### 配额扣除逻辑
```typescript
// 用户发起 AI 提问
function deductQuota(userId, amount) {
  let user = getUser(userId);
  
  if (user.ai_daily_quota >= amount) {
    // 优先扣日配额
    user.ai_daily_quota -= amount;
  } else {
    // 日配额不足，扣除累积配额
    let dailyUsed = user.ai_daily_quota;
    let remainingNeed = amount - dailyUsed;
    
    user.ai_daily_quota = 0;                           // 日配额清零
    user.ai_accumulated_quota -= remainingNeed;        // 扣除累积
    
    // ✨ 重点：不能让 accumulated 低于 0
    if (user.ai_accumulated_quota < 0) {
      return { success: false, error: "配额不足" };
    }
  }
  
  saveUser(user);
  return { success: true };
}
```

---

## 总结

| 配额类型 | 数量 | 重置周期 | 过期 | 累积 |
|---------|------|---------|------|------|
| 每日免费 | 10 次 | 每天 0 点 | ❌ 当天 | ❌ |
| 完成关卡 | +10/20 | — | ✅ **永不** | ✅ 无限 |
| 分享文章 | +10 | — | ✅ **永不** | ✅ 无限 |

**关键承诺**：用户获得的任何奖励配额都永久生效，用户不会失去已赚取的配额。

---

**文档版本**：v1.0  
**最后更新**：2025-12-23
